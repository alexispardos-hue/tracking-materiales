<script>
    // Configuración: Reemplazar con sus valores.
    const API_KEY = 'AIzaSyApDMsqrpdpP3WvmyCx6056F79Iv6aXiTE'; // ¡CRÍTICO! Usar la clave API de Google Maps
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbwMFVvOrhhhy7HQux7XgzZ27MvFUGBJNkOphjzmhjbha_qjaULwIZp2Oiye4j2TxZCD/exec'; // ¡CRÍTICO! La URL de su Web App de Apps Script
    
    // Variables de Estado Global
    let map;
    let activeMarker = null;
    let infoWindow = null;
    let allMaterials = []; // Almacena todos los datos del Google Sheet
    let activeMarkerId = null; // El ID del material actualmente trackeado

    // Variables para la Búsqueda por Descripción
    const resultsContainer = document.getElementById('description-results');
    const resultsList = document.getElementById('results-list');


    /**
     * Inicializa el mapa de Google Maps.
     */
    function initMap() {
        // Coordenadas de Lima, Perú (Centroide inicial)
        const initialCoords = { lat: -12.0464, lng: -77.0428 };
        
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: initialCoords,
            mapId: 'DEMO_MAP_ID' // Puede usar un ID de mapa de la Cloud Console para estilos
        });

        infoWindow = new google.maps.InfoWindow();

        // 1. Carga los datos inmediatamente
        fetchMaterialData();
    }


    /**
     * Obtiene los datos del Google Sheet a través del Apps Script Endpoint.
     */
    function fetchMaterialData() {
        fetch(ENDPOINT_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Fallo en la conexión de red');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // El Apps Script ya garantiza el formato correcto
                    allMaterials = data.data; 
                    document.getElementById('status-message').innerText = `Estado: Datos actualizados. Total de items: ${allMaterials.length}`;
                    
                    // Si el mapa ya está inicializado y hay datos, intenta mostrar el primer elemento automáticamente
                    if (map && allMaterials.length > 0) {
                         // Mostrar el primer elemento al cargar si no hay búsqueda activa
                         if (!activeMarkerId) {
                            const initialId = allMaterials[0].ID_MATERIAL; 
                            // Ejecuta la búsqueda inicial con el primer ID
                            updateActiveMarker(initialId);
                            // Rellena la caja de búsqueda con el ID inicial
                            document.getElementById('material-id-input').value = initialId; 
                            activeMarkerId = initialId; // Actualiza el estado
                        }
                    }

                } else {
                    document.getElementById('status-message').innerText = `ERROR: No se pudieron obtener los datos. ${data.message}`;
                }
            })
            .catch(error => {
                document.getElementById('status-message').innerText = `ERROR: Fallo en la conexión de red. ${error.message}`;
                console.error("Error al obtener datos:", error);
            });
    }

    /**
     * Función principal que se dispara al buscar un ID de material.
     */
    function filterMaterial() {
        const searchId = document.getElementById('material-id-input').value.trim();
        if (!searchId) return;

        // Guarda el ID buscado
        activeMarkerId = searchId;

        // Llama a la función de actualización de marcador
        updateActiveMarker(searchId);
    }


    /**
     * Mueve el marcador activo a la ubicación del material encontrado.
     * Incluye las celdas añadidas para el InfoWindow.
     * @param {string} materialId El ID_MATERIAL a buscar.
     */
    function updateActiveMarker(materialId) {
        // Búsqueda robusta: convierte a string y maneja nulos para evitar el TypeError
        const searchId = materialId.toUpperCase();
        
        // **FILTRADO ROBUSTO**
        const material = allMaterials.find(item => 
            item && item.ID_MATERIAL && item.ID_MATERIAL.toString().toUpperCase() === searchId
        );

        // Limpia el mensaje de advertencia
        document.getElementById('warning-message').innerText = '';

        if (!material) {
            document.getElementById('warning-message').innerText = `Advertencia: Material ${materialId} no encontrado.`;
            // Si el marcador existe, lo oculta
            if (activeMarker) activeMarker.setMap(null); 
            infoWindow.close();
            return;
        }

        const lat = parseFloat(material.LATITUD);
        const lng = parseFloat(material.LONGITUD);

        if (isNaN(lat) || isNaN(lng)) {
            document.getElementById('warning-message').innerText = `Advertencia: Material ${materialId} sin coordenadas válidas.`;
            if (activeMarker) activeMarker.setMap(null); 
            infoWindow.close();
            return;
        }

        const position = { lat: lat, lng: lng };

        // 1. Generar el contenido detallado del InfoWindow (con las celdas añadidas)
        const contentString = `
            <div id="content" style="font-family: Arial, sans-serif; max-width: 300px;">
                <h3 style="margin-top: 0; color: #1a73e8; font-size: 1.2em;">Material: ${material.ID_MATERIAL}</h3>
                <div id="bodyContent">
                    <p><strong>Descripción:</strong> ${material.DESCRIPCION || 'N/A'}</p>
                    <p><strong>Estado:</strong> <span style="font-weight: bold; color: green;">${material.ESTADO || 'N/A'}</span></p>
                    
                    <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                    
                    <p><strong>Cantidad:</strong> ${material.CANTIDAD || 'N/A'}</p>
                    <p><strong>Orden Compra (OC):</strong> ${material.OC || 'N/A'}</p>
                    <p><strong>Guía:</strong> ${material.GUIA || 'N/A'}</p>
                    
                    <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                    
                    <p><strong>Plano de Referencia:</strong> 
                        <a href="#" onclick="event.preventDefault(); alert('El plano es: ${material.PLANO_REF || 'No disponible'}');" style="color: #1a73e8; text-decoration: none; font-weight: bold;">
                            ${material.PLANO_REF || 'Ver Referencia'}
                        </a>
                    </p>
                </div>
            </div>`;


        // 2. Crear o mover el marcador
        if (activeMarker) {
            // Si ya existe, solo se mueve
            activeMarker.setPosition(position);
            // Simula un "parpadeo" visual con la animación
            activeMarker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                activeMarker.setAnimation(null);
            }, 1400); 
        } else {
            // Si no existe, se crea
            activeMarker = new google.maps.Marker({
                position: position,
                map: map,
                title: materialId
            });
            // Añade un listener para que el InfoWindow aparezca al hacer clic
            activeMarker.addListener("click", () => {
                infoWindow.open(map, activeMarker);
            });
        }

        // 3. Abrir InfoWindow y centrar el mapa
        infoWindow.setContent(contentString);
        infoWindow.open(map, activeMarker);
        map.setCenter(position);
        map.setZoom(16);
    }


    // ==========================================================
    // ** FUNCIONES PARA BÚSQUEDA POR DICCIONARIO (DESCRIPCIÓN) **
    // ==========================================================

    /**
     * Filtra los materiales por Descripción, OC, Guía o Plano y actualiza la lista.
     * @param {string} searchTerm El texto introducido por el usuario.
     */
    function filterDescription(searchTerm) {
        // Mínimo de 3 caracteres para iniciar la búsqueda de diccionario
        if (searchTerm.length < 3) {
            resultsContainer.style.display = 'none';
            return;
        }

        const lowerCaseSearch = searchTerm.toLowerCase();

        // Filtra el array de todos los materiales, buscando en múltiples campos
        const filtered = allMaterials.filter(material => {
            // Se añaden los nuevos campos para la búsqueda por diccionario
            const descriptionMatch = (material.DESCRIPCION || '').toLowerCase().includes(lowerCaseSearch);
            const ocMatch = (material.OC || '').toLowerCase().includes(lowerCaseSearch);
            const guiaMatch = (material.GUIA || '').toLowerCase().includes(lowerCaseSearch);
            const planoMatch = (material.PLANO_REF || '').toLowerCase().includes(lowerCaseSearch);

            return descriptionMatch || ocMatch || guiaMatch || planoMatch;
        });

        resultsList.innerHTML = '';

        if (filtered.length > 0) {
            resultsContainer.style.display = 'block';
            
            // Crea un elemento de lista para cada resultado
            filtered.forEach(material => {
                const li = document.createElement('li');
                const materialId = material.ID_MATERIAL;
                const description = material.DESCRIPCION || 'Sin Descripción';
                
                // Crea un enlace para que al hacer clic se busque automáticamente
                li.innerHTML = `
                    <a href="#" onclick="selectMaterialFromList('${materialId}')" style="color: #007bff; text-decoration: none;">
                        <strong>ID ${materialId}</strong>
                    </a>: ${description.substring(0, 50)}${description.length > 50 ? '...' : ''}
                    (OC: ${material.OC || 'N/A'})
                `;
                resultsList.appendChild(li);
            });
        } else {
            resultsContainer.style.display = 'none';
        }
    }

    /**
     * Función auxiliar para buscar el material desde la lista de diccionario.
     * @param {string} materialId El ID_MATERIAL a buscar.
     */
    function selectMaterialFromList(materialId) {
        const inputId = document.getElementById('material-id-input');
        
        // 1. Oculta la lista de resultados de la descripción
        resultsContainer.style.display = 'none';
        
        // 2. Coloca el ID en el campo de búsqueda de ID
        inputId.value = materialId;
        
        // 3. Ejecuta la función de búsqueda por ID, actualizando el mapa
        updateActiveMarker(materialId);
        
        // Previene el scroll o comportamiento por defecto del enlace
        return false; 
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap">
</script>
