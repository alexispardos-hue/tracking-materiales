<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tracking Dinámico (G.A.B.I. System)</title>
    <style>
        /* Estilos base */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }
        /* Estilos para la Mejora 2: Panel lateral y Contenedor Principal */
        .main-container {
            display: flex;
            flex-grow: 1;
        }
        .controls-panel {
            width: 350px; /* Ancho fijo para el panel lateral */
            padding: 15px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            height: 90vh; /* Altura ajustada para ocupar el resto de la vista */
        }
        .search-container input[type="text"], 
        .search-container select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Estilos para el Contenedor de Ficha de Datos */
        #material-details {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 0.9em;
            flex-grow: 1;
            overflow-y: auto;
        }
        #material-details h4 {
            margin-top: 0;
            color: #1a73e8;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .detail-row {
            margin-bottom: 5px;
        }
        .detail-row strong {
            display: inline-block;
            width: 120px; /* Alineación de etiquetas */
            color: #555;
        }
        #results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #results-list li {
            padding: 4px 0;
            border-bottom: 1px dotted #eee;
        }
    </style>
</head>
<body>

    <header>
        <h1>Sistema de Tracking de Materiales <small>(G.A.B.I. System)</small></h1>
    </header>

    <div class="main-container">
        
        <div class="controls-panel">
            
            <div class="search-container">
                <label for="search-selector" style="font-weight: bold;">1. Seleccionar Campo de Búsqueda:</label>
                <select id="search-selector">
                    <option value="ID_MATERIAL">ID de Material (M1, MAT_1)</option>
                    <option value="DESCRIPCION">Descripción</option>
                    <option value="OC">Orden de Compra (OC)</option>
                    <option value="GUIA">Número de Guía</option>
                    <option value="PLANO_REF">Plano de Referencia</option>
                </select>
                
                <label for="search-input" style="font-weight: bold;">2. Escribir Término (Diccionario):</label>
                <input type="text" id="search-input" placeholder="Buscar..." oninput="filterDictionary(this.value)">
                
                <div id="dictionary-results" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 10px; display: none;">
                    <ul id="results-list"></ul>
                </div>
            </div>
            
            <hr style="width: 100%; border-top: 1px solid #eee;">
            
            <div id="status-message" style="margin-bottom: 15px;">Estado: Inicializando sistema...</div>
            
            <div id="material-details" style="display: none;">
                <h4>Ficha de Datos del Material Activo</h4>
                </div>

        </div>

        <div id="map"></div>
    </div>
    
    <script>
        // *** 1. CONFIGURACIÓN CRÍTICA ***
        // ¡REEMPLAZAR ESTAS DOS VARIABLES!
        const API_KEY = 'AIzaSyApDMsqrpdpP3WvmyCx6056F79Iv6aXiTE'; 
        const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbwLsETbP2RB9Wj_BPut-Edk8bT4YSAckEjSb5x-l9atLPqIjDlDbzm_2sqIzLnIsOYA/exec'; 

        // Variables globales del estado del sistema
        let map;
        let allMaterials = [];
        let activeMarker = null; // Marcador actualmente visible
        let activeMarkerId = null; // ID del material activo
        let blinkInterval = null; // CRÍTICO: Variable para controlar el intervalo de parpadeo (3s)
        
        // Carga la API de Google Maps de forma asíncrona
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`;
            script.async = true;
            document.head.appendChild(script);
        }

        // 2. FUNCIÓN DE INICIALIZACIÓN DEL MAPA
        window.initMap = function() {
            // Coordenadas por defecto (Ej: Lima, Perú, para centralizar el inicio)
            const defaultLocation = { lat: -12.0464, lng: -77.0428 }; 

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: defaultLocation,
                mapId: 'DEMO_MAP_ID' // Puede ser sustituido por un ID de mapa personalizado
            });
            
            // Inicia la actualización periódica
            startDataRefresh();
            document.getElementById('status-message').innerText = 'Estado: Sistema listo. Iniciando seguimiento periódico.';
        }

        // 3. FUNCIÓN PARA RECUPERAR DATOS DEL ENDPOINT (ROBUSTA)
        async function fetchMaterialData() {
            try {
                const response = await fetch(ENDPOINT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
                    // FILTRADO ROBUSTO: Excluye cualquier objeto sin ID_MATERIAL (filas vacías/nulas)
                    allMaterials = data.data.filter(item => item && item.ID_MATERIAL); 
                    document.getElementById('status-message').innerText = `Estado: Datos actualizados. Total de items: ${allMaterials.length}`;
                    
                    // Si ya hay un material activo, actualiza solo ese marcador
                    if (activeMarkerId) {
                        updateActiveMarker(activeMarkerId);
                    }
                } else {
                    console.error("Error del Endpoint:", data.message);
                    document.getElementById('status-message').innerText = 'ERROR: No se pudieron obtener los datos.';
                }
            } catch (error) {
                console.error('Error de conexión con Apps Script:', error);
                document.getElementById('status-message').innerText = 'ERROR: Fallo en la conexión de red.';
            }
        }

        // 4. LÓGICA DE BÚSQUEDA POR ID (Usando la tecla ENTER)
        // Mantenida solo por compatibilidad, la búsqueda principal es ahora el diccionario.
        window.filterMaterial = function(event) {
            // Se activa solo al presionar ENTER
            if (event.key !== 'Enter') return; 

            const searchId = document.getElementById('search-input').value.trim().toUpperCase();
            
            if (!searchId) {
                clearActiveMarker();
                return;
            }

            updateActiveMarker(searchId);
        }

        // 5. FUNCIÓN CRÍTICA DE ACTUALIZACIÓN DE MARCADOR (CORREGIDA)
        function updateActiveMarker(searchId) {
            // Busca el material usando las claves limpias del Apps Script
            const material = allMaterials.find(item => item && item.ID_MATERIAL && item.ID_MATERIAL.toUpperCase() === searchId);

            // Limpia el marcador y el ID anterior antes de proceder (limpia el parpadeo)
            clearActiveMarker(); 
            document.getElementById('material-details').style.display = 'none'; // Oculta ficha anterior

            if (material && material.LATITUD && material.LONGITUD) {
                activeMarkerId = searchId; // Establece el ID activo
                
                const position = { 
                    lat: parseFloat(material.LATITUD), 
                    lng: parseFloat(material.LONGITUD) 
                };

                // -------------------------------------------------------------
                // ** GENERACIÓN DEL CONTENT STRING CON CELDAS AÑADIDAS **
                // -------------------------------------------------------------
                const contentString = `
                    <div style="font-family: Arial, sans-serif; max-width: 300px;">
                        <h4 style="margin-top: 0; color: #1a73e8;">Material: ${material.ID_MATERIAL}</h4>
                        <p><strong>Descripción:</strong> ${material.DESCRIPCION || 'N/A'}</p>
                        <p><strong>Estado:</strong> <span style="font-weight: bold; color: green;">${material.ESTADO || 'N/A'}</span></p>
                        
                        <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                        
                        <p><strong>Cantidad:</strong> ${material.CANTIDAD || 'N/A'}</p>
                        <p><strong>OC:</strong> ${material.OC || 'N/A'}</p>
                        <p><strong>Guía:</strong> ${material.GUIA || 'N/A'}</p>
                        <p><strong>Plano Ref:</strong> ${material.PLANO_REF || 'N/A'}</p>
                        
                        <p style="font-size: 0.8em; color: #777;">Lat/Lng: ${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}</p>
                    </div>`;


                // Crea el nuevo marcador 
                activeMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: material.ID_MATERIAL,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#FF0000',
                        fillOpacity: 0.9,
                        strokeWeight: 0,
                    }
                });

                // *** INICIA EL EFECTO DE PARPADEO (3 segundos) ***
                startBlinking(activeMarker, 3000); 
                
                // Centra el mapa en la nueva posición y establece un zoom adecuado
                map.setCenter(position);
                map.setZoom(15); 
                
                // Añade la información en un infowindow
                const infoWindow = new google.maps.InfoWindow({
                    content: contentString
                });

                activeMarker.addListener('click', () => {
                    infoWindow.open(map, activeMarker);
                });

                // CRÍTICO: Llamada para mostrar la ficha de datos
                displayMaterialDetails(searchId); 

                document.getElementById('status-message').innerText = `Estado: Material ${searchId} ubicado y en seguimiento activo.`;

            } else {
                document.getElementById('status-message').innerText = `Advertencia: Material ${searchId} no encontrado o sin coordenadas válidas.`;
            }
        }


        // 6. FUNCIÓN PARA INICIAR EL PARPADEO (3 segundos por ciclo)
        function startBlinking(marker, interval) {
            if (blinkInterval) {
                clearInterval(blinkInterval);
            }
            
            let isVisible = true;
            
            blinkInterval = setInterval(() => {
                const icon = marker.getIcon();
                icon.fillOpacity = isVisible ? 0.2 : 0.9; 
                marker.setIcon(icon);
                isVisible = !isVisible; 
            }, interval / 2); 
        }


        // 7. FUNCIÓN DE LIMPIEZA
        function clearActiveMarker() {
            if (activeMarker) {
                activeMarker.setMap(null);
                activeMarker = null;
                activeMarkerId = null;
            }
            if (blinkInterval) {
                clearInterval(blinkInterval);
                blinkInterval = null;
            }
            document.getElementById('material-details').style.display = 'none'; // Oculta la ficha
        }
        
        // 8. FUNCIÓN DE BUCLE DE ACTUALIZACIÓN
        function startDataRefresh() {
            fetchMaterialData(); 
            setInterval(fetchMaterialData, 5000); 
        }
        
        // ==========================================================
        // ** FUNCIONES PARA BÚSQUEDA POR DICCIONARIO (MEJORA 2) **
        // ==========================================================

        /**
         * Filtra los materiales basándose en el campo seleccionado y el término de búsqueda.
         * Se dispara con oninput.
         */
        function filterDictionary(searchTerm) {
            const selector = document.getElementById('search-selector');
            const searchField = selector.value;
            const resultsContainer = document.getElementById('dictionary-results');
            const resultsList = document.getElementById('results-list');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            const lowerCaseSearch = searchTerm.toLowerCase();

            const filtered = allMaterials.filter(material => {
                // Aseguramos que el material y el campo existan antes de llamar a toString()
                const value = (material && material[searchField] || '').toString().toLowerCase();
                return value.includes(lowerCaseSearch);
            });

            resultsList.innerHTML = '';

            if (filtered.length > 0) {
                resultsContainer.style.display = 'block';
                
                // Limita los resultados a los primeros 10
                filtered.slice(0, 10).forEach(material => {
                    const li = document.createElement('li');
                    const materialId = material.ID_MATERIAL;
                    // Muestra el valor del campo buscado (ej: el nombre del plano o la descripción)
                    const displayValue = material[searchField] || 'N/A'; 
                    
                    li.innerHTML = `
                        <a href="#" onclick="selectMaterialFromList('${materialId}'); return false;" style="color: #007bff; text-decoration: none;">
                            <strong>ID ${materialId}</strong>
                        </a>: ${displayValue}
                    `;
                    resultsList.appendChild(li);
                });
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        /**
         * Función auxiliar para seleccionar el material desde la lista de diccionario.
         */
        window.selectMaterialFromList = function(materialId) {
            const searchInput = document.getElementById('search-input');
            
            document.getElementById('dictionary-results').style.display = 'none';
            searchInput.value = ''; // Limpiamos la caja de búsqueda (opcional)

            // 1. Mueve el marcador
            updateActiveMarker(materialId);
            
            // 2. Muestra la ficha de datos completa (esto también se llama dentro de updateActiveMarker)
            // displayMaterialDetails(materialId); // La llamada está en updateActiveMarker ahora.
        }

        /**
         * Muestra la ficha de datos completa en el panel lateral.
         */
        function displayMaterialDetails(materialId) {
            const material = allMaterials.find(item => item && item.ID_MATERIAL && item.ID_MATERIAL.toUpperCase() === materialId.toUpperCase());
            const detailsDiv = document.getElementById('material-details');
            
            if (!material) {
                detailsDiv.style.display = 'none';
                return;
            }
            
            detailsDiv.style.display = 'block';
            
            let htmlContent = '<h4>Ficha de Datos del Material Activo</h4>';
            
            // Iteramos sobre las claves para mostrarlas ordenadamente
            const keysOrder = ['ID_MATERIAL', 'ESTADO', 'DESCRIPCION', 'CANTIDAD', 'OC', 'GUIA', 'PLANO_REF', 'LATITUD', 'LONGITUD'];
            
            keysOrder.forEach(key => {
                let value = material[key] || 'N/A';
                
                // Excluimos las claves si son nulas o no están en el objeto
                if (value === 'N/A' && !material.hasOwnProperty(key)) return;
                
                const displayKey = key.replace(/_/g, ' ').toUpperCase(); 

                htmlContent += `
                    <div class="detail-row">
                        <strong>${displayKey}:</strong> ${value}
                    </div>
                `;
            });
            
            detailsDiv.innerHTML = htmlContent;
        }

        // Inicia el proceso de carga del script de Google Maps
        loadGoogleMapsScript();
    </script>
</body>
</html>
