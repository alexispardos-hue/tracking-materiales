<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tracking Dinámico (G.A.B.I. System)</title>
    <style>
        /* Estilos base */
        body {
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }
        /* Estilos para la Mejora 2: Panel lateral y Contenedor Principal */
        .main-container {
            display: flex;
            flex-grow: 1;
        }
        .controls-panel {
            width: 350px; /* Ancho fijo para el panel lateral */
            padding: 15px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        /* Contenedor de Mapas (Horizontal) */
        .map-container-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* Mapas apilados verticalmente */
            padding-left: 5px;
        }
        .map-view {
            flex: 1;
            height: 45vh; /* Mitad de la altura para cada mapa */
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }

        #current-map-wrapper {
            position: relative;
            flex: 1;
        }
        #day-counter-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            font-size: 2.5em; /* Número grande */
            font-weight: bold;
            color: #ff0000;
            background-color: rgba(255, 255, 255, 0.7);
            border: 3px solid #ff0000;
            padding: 10px 20px;
            border-radius: 8px;
            pointer-events: none;
            display: none;
            text-shadow: 1px 1px 2px white;
        }
            
        .search-container input[type="text"], 
        .search-container select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        /* Estilos para el Contenedor de Ficha de Datos */
        #material-details {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 0.9em;
            flex-grow: 1;
            overflow-y: auto;
        }
        #material-details h4 {
            margin-top: 0;
            color: #1a73e8;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .detail-row strong {
            display: inline-block;
            width: 120px; /* Alineación de etiquetas */
            color: #555;
        }
        #results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #results-list li {
            padding: 4px 0;
            border-bottom: 1px dotted #eee;
        }
    </style>
</head>
<body>

    <header>
        <h1>Sistema de Tracking de Materiales <small>(© aloris)</small></h1>
    </header>

    <div class="main-container">
        
        <div class="controls-panel">
            
            <div class="search-container">
                <label for="search-selector" style="font-weight: bold;">1. Seleccionar Campo de Búsqueda:</label>
                <select id="search-selector">
                    <option value="ID_MATERIAL">ID de Material (M1, MAT_1)</option>
                    <option value="DESCRIPCION">Descripción</option>
                    <option value="OC">Orden de Compra (OC)</option>
                    <option value="GUIA">Número de Guía</option>
                    <option value="PLANO_REF">Plano de Referencia</option>
                </select>
                
                <label for="search-input" style="font-weight: bold;">2. Escribir Término (Diccionario):</label>
                                <input type="text" id="search-input" placeholder="Buscar..." oninput="filterDictionary(this.value)">
                
                <div id="dictionary-results" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 10px; display: none;">
                    <ul id="results-list"></ul>
                </div>
            </div>
            
            <hr style="width: 100%; border-top: 1px solid #eee;">
            
            <div id="status-message" style="margin-bottom: 15px;">Estado: Inicializando sistema...</div>
            
            <div id="material-details" style="display: none;">
                <h4>Ficha de Datos del Material Activo</h4>
            </div>

        </div>

        <div class="map-container-wrapper">
            <div id="current-map-wrapper">
                <div id="current-map" class="map-view"></div>
                <div id="day-counter-overlay"></div>
            </div>
            
            <div id="history-map" class="map-view"></div>
        </div>
        
    </div>

    
    <script>
// =======================================================================
// *** 1. CONFIGURACIÓN CRÍTICA Y VARIABLES GLOBALES ***
// =======================================================================
// ¡REEMPLAZAR ESTAS DOS VARIABLES!
const API_KEY = 'AIzaSyApDMsqrpdpP3WvmyCx6056F79Iv6aXiTE'; 
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxNy9jTgU3LWha7a5h7o6xR30BM6_qXwvAT7Sb9NF_etE7VJ9ftF-IjAllWNoU_3Q9Y/exec'; 

let map;
let historyMap; // Mapa de Tracking Histórico
let allMaterials = [];
let activeMaterial = null; // Objeto del material activo
let activeMarker = null; 
let activeMarkerId = null;
let blinkInterval = null; 
let historyMarkers = []; 
let polyline = null; 
let initialLoad = true; 
const REFRESH_INTERVAL_MS = 10000; // Refresco cada 10 segundos

// Carga la API de Google Maps de forma asíncrona
function loadGoogleMapsScript() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap`;
    script.async = true;
    document.head.appendChild(script);
}

// =======================================================================
// 2. UTILIDADES DE CÁLCULO DE TIEMPO (Para resolver NaN días)
// =======================================================================

/**
 * Intenta convertir un valor a un objeto Date válido (Ajustando a medianoche UTC para días).
 */
function getValidDate(dateValue) {
    if (!dateValue || dateValue === 'N/A' || dateValue === '') {
        return null;
    }
    
    let date = null;
    
    if (dateValue instanceof Date) {
        date = dateValue;
    } else if (typeof dateValue === 'string') {
        date = new Date(dateValue.split('T')[0]); 
    }

    if (isNaN(date.getTime())) {
        return null;
    }
    
    // Ajuste CRÍTICO: Elimina la hora y el offset para calcular la diferencia de DÍAS exacta.
    date.setHours(0, 0, 0, 0); 
    return date;
}

/**
 * Calcula la diferencia en días entre dos fechas.
 */
function calculateDaysDifference(startDate, endDate) {
    const start = getValidDate(startDate);
    const end = getValidDate(endDate);

    if (!start || !end) {
        return "N/A";
    }

    const MS_PER_DAY = 1000 * 60 * 60 * 24;
    const diffTime = end.getTime() - start.getTime(); 
    
    if (diffTime < 0) return 0; 
    
    const diffDays = Math.round(diffTime / MS_PER_DAY); 
    
    return diffDays;
}

/**
 * PROCESAMIENTO CLAVE: Calcula la permanencia para cada punto histórico.
 */
function processMaterialHistory(material) {
    if (!material || !material.HISTORY || material.HISTORY.length === 0) {
        material.DIAS_ACTUAL = "N/A";
        return;
    }

    const history = material.HISTORY;
    const fechaHoy = new Date(); 

    for (let i = 0; i < history.length; i++) {
        const punto = history[i];
        const fechaLlegada = punto.arrival;
        let fechaSalida;
        let fechaSalidaString;

        if (i < history.length - 1) {
            fechaSalida = history[i + 1].arrival;
            fechaSalidaString = getValidDate(fechaSalida) ? getValidDate(fechaSalida).toLocaleDateString('es-PE') : 'N/A';
        } else {
            fechaSalida = fechaHoy;
            fechaSalidaString = 'En Curso';
        }

        const diasPermanencia = calculateDaysDifference(fechaLlegada, fechaSalida);
        
        // ADJUNTAR DATOS HISTÓRICOS REQUERIDOS
        punto.permanencia = diasPermanencia;
        punto.fecha_llegada = getValidDate(fechaLlegada) ? getValidDate(fechaLlegada).toLocaleDateString('es-PE') : 'N/A';
        punto.fecha_salida = fechaSalidaString;
    }

    // Se establece la permanencia actual (para el overlay principal)
    material.DIAS_ACTUAL = history[history.length - 1].permanencia;
}


// =======================================================================
// 3. INICIALIZACIÓN Y MANEJO DE DATOS (JSONP)
// =======================================================================

/**
 * Función de callback de JSONP (Global para ser llamada por Apps Script).
 */
window.cargarDatosMateriales = function(response) {
    console.log("Datos recibidos:", response);
    
    if (response.status === 'success') {
        allMaterials = response.data.filter(item => item && item.ID_MATERIAL);
        allMaterials.forEach(processMaterialHistory); 
        
        if (initialLoad) {
            document.getElementById('status-message').innerText = `Estado: Sistema listo. Total de materiales: ${allMaterials.length}`;
            initialLoad = false;
        } else {
            document.getElementById('status-message').innerText = `Estado: Datos actualizados. Total de items: ${allMaterials.length}`;
        }
        
        if (activeMaterial && activeMaterial.ID_MATERIAL) {
            updateActiveMarker(activeMaterial.ID_MATERIAL);
        }

    } else {
        console.error("Error del Endpoint:", response.message);
        document.getElementById('status-message').innerText = 'ERROR: No se pudieron obtener los datos.';
    }
}

/**
 * Inicia la carga de datos (JSONP) y establece el intervalo de refresco.
 */
function iniciarCargaDeDatos() {
    // 1. Carga inicial (inyección de script)
    const script = document.createElement('script');
    script.src = `${APPS_SCRIPT_URL}?callback=cargarDatosMateriales`; 
    document.getElementsByTagName('head')[0].appendChild(script);

    // 2. Configura el refresco periódico
    setInterval(() => {
        const refreshScript = document.createElement('script');
        refreshScript.src = `${APPS_SCRIPT_URL}?callback=cargarDatosMateriales&t=${new Date().getTime()}`; 
        document.getElementsByTagName('head')[0].appendChild(refreshScript);
        
        setTimeout(() => refreshScript.remove(), 500); 
    }, REFRESH_INTERVAL_MS); 
}

/**
 * Función de inicialización de los dos mapas (Global para el callback de Google Maps).
 */
window.initMap = function() {
  
    const defaultLocation = { lat: -12.0464, lng: -77.0428 }; 

    map = new google.maps.Map(document.getElementById('current-map'), {
        zoom: 12,
        center: defaultLocation,
       // mapId: 'DEMO_MAP_ID_CURRENT'
    });

    historyMap = new google.maps.Map(document.getElementById('history-map'), { 
        zoom: 12,
        center: defaultLocation,
       // mapId: 'DEMO_MAP_ID_HISTORY' 
    });
    
 //   iniciarCargaDeDatos(); 
}


// =======================================================================
// 4. LÓGICA DE BÚSQUEDA Y MANEJO DE MARCADORES (Funciones Globales Corregidas)
// =======================================================================

/**
 * Filtra los materiales basándose en el campo seleccionado y el término de búsqueda. (GLOBAL)
 */
window.filterDictionary = function(searchTerm) {
    const selector = document.getElementById('search-selector');
    const searchField = selector.value;
    const resultsContainer = document.getElementById('dictionary-results');
    const resultsList = document.getElementById('results-list');
    
    if (!allMaterials || allMaterials.length === 0) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    if (searchTerm.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }

    const lowerCaseSearch = searchTerm.toLowerCase();

    const filtered = allMaterials.filter(material => {
        // Cláusula de salvaguarda contra TypeError
        const value = (material && material[searchField] || '').toString().toLowerCase();
        return value.includes(lowerCaseSearch);
    });

    resultsList.innerHTML = '';
    
    if (filtered.length > 0) {
        resultsContainer.style.display = 'block';
        
        filtered.slice(0, 10).forEach(material => {
            const li = document.createElement('li');
            const materialId = material.ID_MATERIAL;
            const displayValue = material[searchField] || 'N/A';
            
            li.innerHTML = `
                <a href="#" onclick="selectMaterialFromList('${materialId}'); return false;" style="color: #007bff; text-decoration: none;">
                    <strong>ID ${materialId}</strong>
                </a>: ${displayValue}
            `;
            resultsList.appendChild(li);
        });
    } else {
        resultsContainer.style.display = 'none';
    }
};

/**
 * Función auxiliar para seleccionar el material desde la lista de diccionario. (GLOBAL)
 */
window.selectMaterialFromList = function(materialId) {
    const searchInput = document.getElementById('search-input');
    
    document.getElementById('dictionary-results').style.display = 'none';
    searchInput.value = ''; 

    updateActiveMarker(materialId);
};


/**
 * Función CRÍTICA de actualización de marcador.
 */
function updateActiveMarker(searchId) {
    const material = allMaterials.find(item => item && item.ID_MATERIAL && item.ID_MATERIAL.toUpperCase() === searchId.toUpperCase());

    clearActiveMarker(); 
    document.getElementById('material-details').style.display = 'none'; 
    document.getElementById('day-counter-overlay').style.display = 'none'; 
    
    if (material && material.LATITUD && material.LONGITUD) {
        activeMaterial = material; 
        activeMarkerId = searchId;
        
        const position = { 
            lat: parseFloat(material.LATITUD), 
            lng: parseFloat(material.LONGITUD) 
        };

        // Generación del Content String
        const contentString = `
            <div style="font-family: Arial, sans-serif; max-width: 300px;">
                <h4 style="margin-top: 0; color: #1a73e8;">Material: ${material.ID_MATERIAL}</h4>
                <p><strong>Descripción:</strong> ${material.DESCRIPCION || 'N/A'}</p>
                <p><strong>Estado:</strong> <span style="font-weight: bold; color: green;">${material.ESTADO || 'N/A'}</span></p>
                <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                <p><strong>Cantidad:</strong> ${material.CANTIDAD || 'N/A'}</p>
                <p><strong>OC:</strong> ${material.OC || 'N/A'}</p>
                <p><strong>Guía:</strong> ${material.GUIA || 'N/A'}</p>
                <p><strong>Plano Ref:</strong> ${material.PLANO_REF || 'N/A'}</p>
                <p style="font-size: 0.8em; color: #777;">Lat/Lng: ${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}</p>
            </div>`;


        // Crea el nuevo marcador 
        activeMarker = new google.maps.Marker({
             position: position,
             map: map,
             title: material.ID_MATERIAL,
             icon: {
                 path: google.maps.SymbolPath.CIRCLE,
                 scale: 10,
                 fillColor: '#FF0000',
                 fillOpacity: 0.9,
                 strokeWeight: 0,
             }
         });
         
         startBlinking(activeMarker, 3000); 

         map.setCenter(position);
         map.setZoom(15); 
         
         const infoWindow = new google.maps.InfoWindow({ content: contentString });
         activeMarker.addListener('click', () => { infoWindow.open(map, activeMarker); });
         
         displayMaterialDetails(material.ID_MATERIAL); 
         updateDayCounter(material); 

         if (material.HISTORY && material.HISTORY.length > 0) {
             plotHistoricalTracking(material, position);
         } else {
             clearHistoryTracking();
         }

         document.getElementById('status-message').innerText = `Estado: Material ${searchId} ubicado y en seguimiento activo.`;

    } else {
        document.getElementById('status-message').innerText = `Advertencia: Material ${searchId} no encontrado o sin coordenadas válidas.`;
    }
}

/**
 * LÓGICA DE TRACKING HISTÓRICO (Usa los datos calculados en processMaterialHistory).
 */
function plotHistoricalTracking(material, currentPosition) {
    clearHistoryTracking(); 
    document.getElementById('history-map').style.display = 'block'; 

    const pathCoordinates = [];
    const bounds = new google.maps.LatLngBounds();
    
    material.HISTORY.forEach((point, index) => {
        const position = { lat: parseFloat(point.lat), lng: parseFloat(point.lng) };
        
        pathCoordinates.push(position);
        bounds.extend(position);

        if (index === material.HISTORY.length - 1) {
             // Marcador de la posición actual en el mapa histórico (ej: un cuadrado)
             const marker = new google.maps.Marker({
                 position: position,
                 map: historyMap,
                 title: `Punto Actual: ${point.fecha_llegada}`,
                 icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 6,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 1,
                    strokeColor: '#AA0000'
                 }
             });
             historyMarkers.push(marker);
        } else {
            // Marcador Histórico (Azul) para puntos anteriores
            const marker = new google.maps.Marker({
                position: position,
                map: historyMap,
                title: `Punto Histórico ${index + 1}: ${point.fecha_llegada}`,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 6,
                    fillColor: '#0000FF',
                    fillOpacity: 0.8,
                    strokeWeight: 1,
                    strokeColor: '#0000CC'
                }
            });
            
            // InfoWindow con los 3 datos CLAVE (ya calculados)
            const infoContent = `
                <div style="font-size: 0.9em;">
                    <strong>Punto Histórico ${index + 1}</strong><br>
                    Llegada: <b>${point.fecha_llegada}</b><br>
                    Salida: <b>${point.fecha_salida}</b><br>
                    <span style="font-weight: bold; color: blue;">Permanencia: ${point.permanencia} días</span>
                </div>
            `;
            const infoWindow = new google.maps.InfoWindow({ content: infoContent });
            marker.addListener('click', () => { infoWindow.open(historyMap, marker); });
            historyMarkers.push(marker);
        }
    });

    // Dibuja la polilínea
    polyline = new google.maps.Polyline({
        path: pathCoordinates,
        geodesic: true,
        strokeColor: '#0000FF',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        map: historyMap
    });

    if (!bounds.isEmpty()) {
        historyMap.fitBounds(bounds);
    }
}

/**
 * LÓGICA DEL CONTADOR DE DÍAS (SUPERPUESTO)
 */
function updateDayCounter(material) {
    const counterDiv = document.getElementById('day-counter-overlay');
    
    if (material.DIAS_ACTUAL === 'N/A' || material.DIAS_ACTUAL === undefined) {
        counterDiv.style.display = 'none';
        return;
    }

    counterDiv.innerText = `${material.DIAS_ACTUAL} días`;
    counterDiv.style.display = 'block';
}


// =======================================================================
// 5. FUNCIONES DE UTILIDAD (Parpadeo, Limpieza, Detalles)
// =======================================================================

function startBlinking(marker, interval) {
    if (blinkInterval) {
        clearInterval(blinkInterval);
    }
    
    let isVisible = true;
    
    blinkInterval = setInterval(() => {
        const icon = marker.getIcon();
        // Cambia la opacidad para simular el parpadeo
        icon.fillOpacity = isVisible ? 0.2 : 0.9; 
        marker.setIcon(icon);
        isVisible = !isVisible; 
    }, interval / 2); 
}

function clearHistoryTracking() {
    historyMarkers.forEach(marker => marker.setMap(null));
    historyMarkers = [];
    
    if (polyline) {
        polyline.setMap(null);
        polyline = null;
    }
    
    // Oculta el contenedor si no hay seguimiento
    document.getElementById('history-map').style.display = 'none';
}

function clearActiveMarker() {
    if (activeMarker) {
        activeMarker.setMap(null);
        activeMarker = null;
        activeMaterial = null; 
        activeMarkerId = null;
    }
    if (blinkInterval) {
        clearInterval(blinkInterval);
        blinkInterval = null;
    }
    document.getElementById('material-details').style.display = 'none'; 
    document.getElementById('day-counter-overlay').style.display = 'none'; 
    clearHistoryTracking(); 
    
    if (initialLoad === false) { 
        document.getElementById('status-message').innerText = 'Estado: Seguimiento inactivo. Seleccione un material.'; 
    }
}


/**
 * Muestra la ficha de datos completa en el panel lateral.
 */
function displayMaterialDetails(materialId) {
    const material = allMaterials.find(item => item && item.ID_MATERIAL && item.ID_MATERIAL.toUpperCase() === materialId.toUpperCase());
    const detailsDiv = document.getElementById('material-details');
    
    if (!material) {
        detailsDiv.style.display = 'none';
        return;
    }
    
    detailsDiv.style.display = 'block';
    
    let htmlContent = '<h4>Ficha de Datos del Material Activo</h4>';
    
    const keysOrder = ['ID_MATERIAL', 'ESTADO', 'DESCRIPCION', 'CANTIDAD', 'OC', 'GUIA', 'PLANO_REF', 'LATITUD', 'LONGITUD', 'FECHA_ACTUALIZACION']; 
    
    keysOrder.forEach(key => {
        let value = material[key] || 'N/A';
        
        if (value === 'N/A' && !material.hasOwnProperty(key)) return;
        
        const displayKey = key.replace(/_/g, ' ').toUpperCase(); 

        htmlContent += `
            <div class="detail-row">
                <strong>${displayKey}:</strong> ${value}
            </div>
        `;
    });

    // Lógica de visualización del historial en la ficha
    if (material.HISTORY && material.HISTORY.length > 0) {
        htmlContent += `<h4 style="margin-top: 15px;">Historial de Movimientos (${material.HISTORY.length})</h4>`;
        
        material.HISTORY.forEach((point, index) => {
            // Usamos los campos ya procesados
            const arrival = point.fecha_llegada || 'N/A'; 
            const departure = point.fecha_salida || 'En Curso';
            const days = point.permanencia || 'N/A';
            const lat = parseFloat(point.lat).toFixed(4);
            const lng = parseFloat(point.lng).toFixed(4);
            
            htmlContent += `
                <div class="detail-row" style="margin-bottom: 5px; border-left: 3px solid #ccc; padding-left: 5px;">
                    <strong>#${index + 1} (${days} días):</strong> Arribo: ${arrival} / Salida: ${departure}
                </div>
            `;
        });
    }
    
    detailsDiv.innerHTML = htmlContent;
}

// Inicia el proceso de carga del script de Google Maps (esto llama a initMap)
loadGoogleMapsScript();
</script>


</body>
</html>
