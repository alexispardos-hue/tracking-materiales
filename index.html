<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.A.B.I. - Tracking de Materiales</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .main-container {
            display: flex;
            flex-grow: 1;
        }
        .controls-panel {
            width: 300px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #map {
            flex-grow: 1;
            height: calc(100vh - 56px); /* Altura total menos el header */
        }
        .search-container input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #status-message {
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
        }
        #warning-message {
            color: #ff0000;
            font-weight: bold;
            margin-top: 5px;
        }
        /* Estilos para el Diccionario de Búsqueda */
        #description-results {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        #results-list li {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        #results-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

    <header>
        <h1> Sistema de Tracking de Materiales <small>(© aloris)</small></h1>
    </header>

    <div class="main-container">
        
        <div class="controls-panel">
            
            <div class="search-container">
                <label for="material-id-input" style="font-weight: bold;">Buscar Material por ID:</label>
                <input type="text" id="material-id-input" placeholder="Ej: M1 o MAT_1" 
                    onkeyup="if(event.key === 'Enter') filterMaterial()">
            </div>
            
            <hr>

            <div class="search-container">
                <label for="search-description" style="font-weight: bold;">Búsqueda por Diccionario:</label>
                <input type="text" id="search-description" placeholder="Buscar por descripción, OC o plano..." onkeyup="filterDescription(this.value)">
            </div>
            
            <div id="description-results" style="display: none;">
                <h4 style="margin-top: 0;">Resultados Encontrados:</h4>
                <ul id="results-list">
                    </ul>
            </div>
            
            <hr>

            <div id="status-message">Estado: Inicializando...</div>
            <div id="warning-message"></div>

        </div>

        <div id="map"></div>

    </div>

<script>
    // ==========================================================
    // ** CONFIGURACIÓN CRÍTICA: SUSTITUIR ESTOS VALORES **
    // ==========================================================
    const API_KEY = 'AIzaSyApDMsqrpdpP3WvmyCx6056F79Iv6aXiTE'; // Reemplazar con su API Key de Google Maps Platform
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbwEcyp7SGFcqDw87NvbaUyFxmEOK411VnxK13Ef5cMou7nQ_g_-iPsMYVjX9PJwAo7r/exec'; // Reemplazar con la URL de su Web App de Apps Script
    // ==========================================================

    // Variables de Estado Global
    let map;
    let activeMarker = null;
    let infoWindow = null;
    let allMaterials = []; // Almacena todos los datos del Google Sheet
    let activeMarkerId = null; // El ID del material actualmente trackeado

    // Referencias a los contenedores del Diccionario
    const resultsContainer = document.getElementById('description-results');
    const resultsList = document.getElementById('results-list');


    /**
     * Inicializa el mapa de Google Maps.
     */
    function initMap() {
        // Coordenadas de Lima, Perú (Centroide inicial)
        const initialCoords = { lat: -12.0464, lng: -77.0428 };
        
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: initialCoords,
            mapId: 'DEMO_MAP_ID' 
        });

        infoWindow = new google.maps.InfoWindow();

        // 1. Carga los datos inmediatamente
        fetchMaterialData();
    }


    /**
     * Obtiene los datos del Google Sheet a través del Apps Script Endpoint.
     */
    function fetchMaterialData() {
        fetch(ENDPOINT_URL)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Fallo en la conexión de red');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    allMaterials = data.data; 
                    document.getElementById('status-message').innerText = `Estado: Datos actualizados. Total de items: ${allMaterials.length}`;
                    
                    if (map && allMaterials.length > 0) {
                         // Mostrar el primer elemento al cargar
                         if (!activeMarkerId) {
                            const initialId = allMaterials[0].ID_MATERIAL; 
                            updateActiveMarker(initialId);
                            document.getElementById('material-id-input').value = initialId; 
                            activeMarkerId = initialId;
                        }
                    }

                } else {
                    document.getElementById('status-message').innerText = `ERROR: No se pudieron obtener los datos. ${data.message}`;
                }
            })
            .catch(error => {
                document.getElementById('status-message').innerText = `ERROR: Fallo en la conexión de red. ${error.message}`;
                console.error("Error al obtener datos:", error);
            });
    }

    /**
     * Función principal que se dispara al buscar un ID de material (al presionar Enter).
     */
    function filterMaterial() {
        const searchId = document.getElementById('material-id-input').value.trim();
        if (!searchId) return;

        activeMarkerId = searchId;
        updateActiveMarker(searchId);
    }


    /**
     * Mueve el marcador activo a la ubicación del material encontrado y actualiza el InfoWindow
     * con todos los detalles (incluyendo las celdas añadidas).
     * @param {string} materialId El ID_MATERIAL a buscar.
     */
    function updateActiveMarker(materialId) {
        const searchId = materialId.toUpperCase();
        
        // **FILTRADO ROBUSTO contra nulos en el ID_MATERIAL**
        const material = allMaterials.find(item => 
            item && item.ID_MATERIAL && item.ID_MATERIAL.toString().toUpperCase() === searchId
        );

        document.getElementById('warning-message').innerText = '';

        if (!material) {
            document.getElementById('warning-message').innerText = `Advertencia: Material ${materialId} no encontrado.`;
            if (activeMarker) activeMarker.setMap(null); 
            infoWindow.close();
            return;
        }

        const lat = parseFloat(material.LATITUD);
        const lng = parseFloat(material.LONGITUD);

        if (isNaN(lat) || isNaN(lng)) {
            document.getElementById('warning-message').innerText = `Advertencia: Material ${materialId} sin coordenadas válidas.`;
            if (activeMarker) activeMarker.setMap(null); 
            infoWindow.close();
            return;
        }

        const position = { lat: lat, lng: lng };

        // 1. Generar el contenido detallado del InfoWindow (con las celdas añadidas)
        const contentString = `
            <div id="content" style="font-family: Arial, sans-serif; max-width: 300px;">
                <h3 style="margin-top: 0; color: #1a73e8; font-size: 1.2em;">Material: ${material.ID_MATERIAL}</h3>
                <div id="bodyContent">
                    <p><strong>Descripción:</strong> ${material.DESCRIPCION || 'N/A'}</p>
                    <p><strong>Estado:</strong> <span style="font-weight: bold; color: green;">${material.ESTADO || 'N/A'}</span></p>
                    
                    <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                    
                    <p><strong>Cantidad:</strong> ${material.CANTIDAD || 'N/A'}</p>
                    <p><strong>Orden Compra (OC):</strong> ${material.OC || 'N/A'}</p>
                    <p><strong>Guía:</strong> ${material.GUIA || 'N/A'}</p>
                    
                    <hr style="border-top: 1px solid #eee; margin: 8px 0;">
                    
                    <p><strong>Plano de Referencia:</strong> 
                        <a href="#" onclick="event.preventDefault(); alert('El plano es: ${material.PLANO_REF || 'No disponible'}');" style="color: #1a73e8; text-decoration: none; font-weight: bold;">
                            ${material.PLANO_REF || 'Ver Referencia'}
                        </a>
                    </p>
                </div>
            </div>`;


        // 2. Crear o mover el marcador
        if (activeMarker) {
            activeMarker.setPosition(position);
            activeMarker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                activeMarker.setAnimation(null);
            }, 1400); 
        } else {
            activeMarker = new google.maps.Marker({
                position: position,
                map: map,
                title: materialId
            });
            activeMarker.addListener("click", () => {
                infoWindow.open(map, activeMarker);
            });
        }

        // 3. Abrir InfoWindow y centrar el mapa
        infoWindow.setContent(contentString);
        infoWindow.open(map, activeMarker);
        map.setCenter(position);
        map.setZoom(16);
    }


    // ==========================================================
    // ** FUNCIONES PARA BÚSQUEDA POR DICCIONARIO (DESCRIPCIÓN) **
    // ==========================================================

    /**
     * Filtra los materiales por Descripción, OC, Guía o Plano y actualiza la lista.
     * @param {string} searchTerm El texto introducido por el usuario.
     */
    function filterDescription(searchTerm) {
        if (searchTerm.length < 3) {
            resultsContainer.style.display = 'none';
            return;
        }

        const lowerCaseSearch = searchTerm.toLowerCase();

        const filtered = allMaterials.filter(material => {
            // Búsqueda en todos los campos de metadata
            const descriptionMatch = (material.DESCRIPCION || '').toLowerCase().includes(lowerCaseSearch);
            const ocMatch = (material.OC || '').toLowerCase().includes(lowerCaseSearch);
            const guiaMatch = (material.GUIA || '').toLowerCase().includes(lowerCaseSearch);
            const planoMatch = (material.PLANO_REF || '').toLowerCase().includes(lowerCaseSearch);

            return descriptionMatch || ocMatch || guiaMatch || planoMatch;
        });

        resultsList.innerHTML = '';

        if (filtered.length > 0) {
            resultsContainer.style.display = 'block';
            
            filtered.forEach(material => {
                const li = document.createElement('li');
                const materialId = material.ID_MATERIAL;
                const description = material.DESCRIPCION || 'Sin Descripción';
                
                li.innerHTML = `
                    <a href="#" onclick="selectMaterialFromList('${materialId}'); return false;" style="color: #007bff; text-decoration: none;">
                        <strong>ID ${materialId}</strong>
                    </a>: ${description.substring(0, 50)}${description.length > 50 ? '...' : ''}
                    (OC: ${material.OC || 'N/A'})
                `;
                resultsList.appendChild(li);
            });
        } else {
            resultsContainer.style.display = 'none';
        }
    }

    /**
     * Función auxiliar para buscar el material desde la lista de diccionario.
     * @param {string} materialId El ID_MATERIAL a buscar.
     */
    function selectMaterialFromList(materialId) {
        const inputId = document.getElementById('material-id-input');
        
        resultsContainer.style.display = 'none';
        inputId.value = materialId;
        
        updateActiveMarker(materialId);
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMap">
</script>

</body>
</html>
